<html>

<head>
    <meta charset="UTF-8">
    <title>FaceTracking</title>
    <script src="https://www.auduno.com/clmtrackr/build/clmtrackr.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        #videoContainer {
            margin-top: 20px;
        }

        video {
            border: 2px solid #333;
            border-radius: 8px;
        }

        input,
        button {
            padding: 8px 12px;
            margin: 5px;
            font-size: 14px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }
    </style>
</head>

<body>
    <h1>Face Tracking to WebSockets</h1>
    
    <div>
        <label for="landmarksInput">List of Numbered Landmarks to Send</label>
        <input type="text" id="landmarksInput" value="27,32,62,51-55">
    </div>

    <div>
        <label for="hostInput">Server Address</label>
        <input type="text" id="hostInput" value="localhost:12000"> <button id="connectBtn">Connect to Server</button>
    </div>

    <div id="videoContainer">
        <video id="video" width="400" height="300" autoplay playsinline></video>
    </div>

    <div>
        <button id="togglePreviewBtn">Toggle Preview</button>
    </div>

    <script>
        let socket;
        let connected = false;
        let tracker;
        let video;

        const w = 400; // the WIDTH  of the video
        const h = 300; // the HEIGHT of the video

        function connectWebSocketAndStartTracking(hostPort) {
            console.log("Trying to connect to ws://" + hostPort);
            socket = new WebSocket('ws://' + hostPort);
            socket.onopen = openHandler;
            socket.onerror = errorHandler;
            socket.onclose = closeHandler;
            setupTracking();
        }

        document.getElementById("connectBtn").addEventListener("click", function () {
            const hostPort = document.getElementById("hostInput").value.trim();
            if (!hostPort) {
                alert("Please enter a hostname and port.");
                return;
            }
            connectWebSocketAndStartTracking(hostPort);
        });

        document.getElementById("togglePreviewBtn").addEventListener("click", function () {
            let video = document.getElementById('video')
            if (video.style.display == 'none') {
                video.style.display = 'block'
            } else {
                video.style.display = 'none'
            }
        });


        function openHandler() {
            document.getElementById("hostInput").disabled = true;
            document.getElementById("connectBtn").innerHTML = 'Connected';
            document.getElementById("connectBtn").disabled = true;
            connected = true;
            console.log("Connected via WebSocket");
        }

        function errorHandler(event) {
            setTimeout(() => {
                document.getElementById("hostInput").style.display = "none"
                document.getElementById("connectBtn").innerHTML = 'WS Error! Refresh and try again';
                document.getElementById("connectBtn").style.backgroundColor = "red";
                document.getElementById("connectBtn").disabled = true;
                connected = false;
                console.error("WebSocket error:", event);
            }, 0);

        }

        function closeHandler() {
            document.getElementById("hostInput").disabled = false;
            document.getElementById("connectBtn").innerHTML = 'Connect';
            connected = false;
            console.log("Connection closed");
        }

        function expandIndexString(str) {
            const parts = str.split(",");
            const result = [];

            for (let part of parts) {
                if (part.includes("-")) {
                    const [start, end] = part.split("-").map(Number);
                    for (let i = start; i <= end; i++) {
                        result.push(i);
                    }
                } else {
                    result.push(Number(part));
                }
            }
            return result;
        }

        function updateTracking() {
            if (connected == false) return;

            let positions = tracker.getCurrentPosition();
            if (positions && positions.length > 0) {
                const landmarksList = document.getElementById("landmarksInput").value.trim()
                const landmarkIndexes = expandIndexString(landmarksList)
                const obj = {}
                for (let i of landmarkIndexes) {
                    obj[`${i}_x`] = positions[i][0];
                    obj[`${i}_y`] = positions[i][1];
                }
                // now map all of the values to a range -.5 to .5 (based on the width or height)
                for (let key in obj) {
                    if (key.endsWith("_x")) {
                        obj[key] = -0.5 + obj[key] / w;
                    } else if (key.endsWith("_y")) {
                        obj[key] = -0.5 + obj[key] / h;
                    }
                }
                socket.send(JSON.stringify(obj));
            }
            requestAnimationFrame(updateTracking);
        }

        function setupTracking() {
            video = document.getElementById('video');

            // Use getUserMedia to access the webcam
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: {
                        width: w,
                        height: h
                    }
                })
                    .then(function (stream) {
                        console.log('Video ready.');
                        video.srcObject = stream;
                        video.style.display = 'none';

                        // Wait for video to be ready before starting tracker
                        video.addEventListener('loadedmetadata', function () {
                            tracker = new clm.tracker();
                            tracker.init();
                            tracker.start(video);

                            // Start tracking loop
                            requestAnimationFrame(updateTracking);
                        });
                    })
                    .catch(function (err) {
                        console.error('Error accessing webcam:', err);
                        alert('Could not access webcam. Please ensure you have granted camera permissions.');
                    });
            } else {
                alert('getUserMedia is not supported in your browser.');
            }
        }
    </script>
</body>

</html>